---
title: 服务器管理
date: 2022-10-25 09:18:14
toc: true
tags: reach
categories:
  - linux
excerpt: REACH服务器
password: xdxie@reach
message: 内容升级中...

---

# REACH 服务器

- 存储r001~r008
- r001 台式电脑备份
- r006 公共资源 最终结果输出位置
- r008 20T空间
- 刀片 n001~n010 第一批 16核 n011~n016 第二批 24核 n017~n26 第三批 36核
- 开机顺序： 存储（5mins左右)，管理节点（10mins左右），计算节点
- 关机顺序相反: shutdown now
- IP 10.255.246.2 账号 trstud 密码 Reach2021
- 关机操作
  - 计算节点关机：clusconf -f /opt/node_list -yd "shutdown -h now"
  - 有五组服务器：
    - admin及计算节点（先关机）
    - admin2及计算节点（直接关机） LteL0yZJ2edT37hM
    - 存储（10.10.10.101 102 103 104）（等admin关机后再关机）
    - 预报服务器（直接关机）
    - 小机器（最后关机）
- 开机操作
  - admin及计算节点：
    - 检查机器状态及挂载 clusconf -f /opt/node_list -yd "df -t nfs | sort"
    - 启动pbs
  - 预报服务器和小机器
    - 将预报data挂载到小机器 ```sshfs -o allow_other root@pre:/data/ /data/pre/```
    - 检查时间是否同步
  - admin2及计算节点
    - 检查机器状态及挂载 clusconf -f /opt/node_list -yd "df -h | sort"
    - 检查nfs服务是否开启 service nfs status
    - 重启nfs服务 systemctl restart nfs
    - 挂载 clusconf -f /opt/node_list -yd "mount -t nfs admin2:/data /data"
    - 其他服务器能连上，远程连不上，需要重启sshd： service sshd restart

# 状态监测

```shell
# 查看磁盘IO情况
iostat -x 1

```



# 时间同步

```shell
# 时间服务器上需开启ntpd服务，客户端不开启
# 同步失败需要在admin上开启
service ntpd status
service ntpd start

# 同步设置
/usr/sbin/ntpdate 10.10.10.100

* * * * * /usr/sbin/ntpdate 10.10.10.100 >& /dev/null &
```

# 自动挂载

- 挂载命令加入到 /etc/rc.local 会自动挂载: source /etc/nfs.local

- ```bash
  mount -t nfs -o nfsvers=3 storage1:/home /home
  mount -t nfs -o nfsvers=3 storage1:/r001 /r001
  mount -t nfs -o nfsvers=3 storage1:/r002 /r002
  mount -t nfs -o nfsvers=3 storage2:/r003 /r003
  mount -t nfs -o nfsvers=3 storage2:/r004 /r004
  mount -t nfs -o nfsvers=3 istorage3:/r005 /r005
  mount -t nfs -o nfsvers=3 istorage3:/r006 /r006
  mount -t nfs -o nfsvers=3 storage4:/r007 /r007
  mount -t nfs -o nfsvers=3 storage4:/r008 /r008
  #mount -t nfs -o nfsvers=3 admin:/public /public
  ```

- 或者

  - mount -t nfs -Oremount,nfsvers=3 storage1:/r001 /r001

- clusconf -f /opt/node_list -yd "df -t nfs | sort"

  

- nfs挂载问题（存储后启动处理办法）

  - 在服务器上先停止rpcbind
    - service rpcbind stop
  - 然后停止nfs
    - service nfs stop
  - 最后启动rpcbind和nfs，一定按这个顺序
    - service rpcbind start
    - service nfs start

- 小机器挂载

  ```sshfs -o allow_other root@pre:/data/ /data/pre/```

- 挂载到自己账号下

```sshfs xdxie@10.10.10.111:/home/xdxie/data/work pre```

- r008挂到预报服务器上

- ```sshfs xdxie@10.10.10.100:/r008/xdxie/data /data/xdxie/r008```

  

- 卸载

```fusermount -u pre```

# 网络问题

- network unreachable
  - service network restart
- 在storage1 2 上可以登录其他机器但是其他机器不能登录这两
  - service sshd restart

# 启动pbs

```bash
# 
/etc/init.d/pbs_sched restart
/etc/init.d/pbs_server restart
/etc/init.d/trqauthd restart
clusconf -f /opt/node_list -yd "/etc/init.d/pbs_mom restart"
qnodes
```

- 服务器重启后PBS出现一直排队的情况，重启PBS服务后解决


# 用户及同步

```bash
# 新建用户
useradd pxli -g master -d /home/pxli
clusconf -f /opt/node_list --sync-user

# 同步到storage
clusconf -f /home/kjgong/const/hosts.storage -yu


####### 平时不需要
# 新建用户组
groupadd group1

# 改变用户组
# 强制
usermod -g group user
# 加入新组
usermod -G group user

# 查看用户信息
id xdxie
#> uid=1038(xdxie) gid=1060(postdoc) groups=1060(postdoc)

# 查看用户、组信息
cat /etc/passwd
cat /etc/group

grep xdxie /etc/passwd
#> xdxie:x:1038:1060::/home/xdxie:/bin/bash
grep 1060 /etc/group
#> postdoc:x:1060:


```

# 批量删除任务

```bash
ps -ef | grep nodes_status | grep -v 'grep' | awk '{print $2}' |xargs kill -9
```

# 移动硬盘挂载问题

- 

```shell
# 运行fdisk –l后，显示如下：
    fdisk -l
# 找到对应的硬盘位置： 一般是 /dev/sdd 或者 /dev/sdb 之类的
#  运行parted /dev/sdd print，显示如下：
    [root@storage4 ~]# parted /dev/sdd print
    Model: WD My Passport 25E2 (scsi)
    Disk /dev/sdd: 4001GB
    Sector size (logical/physical): 512B/4096B
    Partition Table: gpt
    Disk Flags:

    Number  Start   End     Size    File system  Name         Flags
     1      1049kB  4001GB  4001GB  ntfs         My Passport

# 看到sdd1是ntfs格式的，用ntfs格式挂载sdd1
	mount –t ntfs /dev/sdd1 /home/mypassport

# 出现问题：mount: unknown filesystem type 'ntfs' 
# Linux上无法识别NTFS格式的分区
# 解决方法：安装 ntfs-3g
# 下载：wget https://tuxera.com/opensource/ntfs-3g_ntfsprogs-2017.3.23.tgz
# 解压，安装： 
    ./configure 
    make 
    make install

# 用mount –t ntfs-3g挂载
	mount -t ntfs-3g /dev/sdd1 MYPassport
```

# mount 问题

```shell
Stale NFS file handle的解决方法
 

早上来到公司，发现有两台server有问题。 因为用df -k察看磁盘使用情况时，一台机器报如下错误： Stale NFS file handle。 另外一台整个就没反应。 后来查了一些资料，说是“ 当我们已mount 上的file or directory ,在server上突然被remove or unexport ,就会出现此讯
　　  早上来到公司，发现有两台server有问题。
因为用df -k察看磁盘使用情况时，一台机器报如下错误：
Stale NFS file handle。
另外一台整个就没反应。
后来查了一些资料，说是“ 当我们已mount 上的file or directory ,在server上突然被remove or unexport ,就会出现此讯息“。
就是说，假如client端mount上了server端的directory之后，假如server端又将这个directory unshare了，那么就会在client端出现这个错误。

正文：

其实解决办法很简单，就是在client上把那个文档unmount掉。
可是其实做起来很难，因为经常会得到 is busy的错误。

能够用下面的三个方法：
1)用fuser杀掉占用那个目录的进程
fuser -k /directory

2)在启动的进程里面查找
ps -ef |awk '{print }' |grep -v PID |xargs /usr/proc/bin/pwdx 

这种方法只能在solaris8及以上版本使用

3)umount -f /directory
强制umount
```



# df卡住问题

```bash
# 首先就是使用strace去追踪到底在哪里卡住了
strace df -h

# 需要 umount 后重新挂载
umount /r007

# 然而遇见问题
# 解决umount.nfs: /data: device is busy 问题
fuser -m -v /r007
显示

                     USER        PID ACCESS COMMAND
/r008:               root     kernel mount /r008
                     xdxie     16972 ..c.. screen

# 第一个kernel 表示fuser的程序
# 需要 fuser -u /r008 卸载，
# kill 下面的程序
# 然后再 umount /r008
# 最后重新挂载就行

```